# 自动提问功能调试指南

## 问题描述
用户反馈：选择"向 AI 提问"后，并没有新建页面然后直接发送，卡在上一个页面了。

## 已实施的改进

### 1. **增强的调试日志**
在 `preload.js` 中添加了详细的调试信息：
- 打印完整的 action 对象
- 尝试多种方式获取用户输入（payload、text、code）
- 显示每一步的执行状态

### 2. **多种触发方式**
现在支持以下几种触发方式：

#### 方式 A: 选中文本（type: "over"）
- 选中任何文本
- 在 utools 中选择"使用AI进行web搜索"
- 适合处理选中的内容

#### 方式 B: 输入任意内容（type: "regex"）
- 在 utools 输入框输入任意内容（2-500字符）
- 会显示"向AI提问"选项
- 适合直接输入问题

#### 方式 C: 关键词触发
- 输入 `问 你的问题`
- 输入 `搜 你的问题`
- 输入 `search 你的问题`

## 如何调试

### 第一步：打开开发者工具
1. 在 utools 中打开插件
2. 按 `F12` 或 `Cmd+Option+I` 打开开发者工具
3. 切换到 Console 标签页

### 第二步：测试输入
尝试以下几种输入方式：

**测试 1: 使用关键词**
```
输入: 问 今天天气怎么样
```
观察控制台输出：
- ✅ 应该看到：`进入 AI 提问 - 完整 action 对象:`
- ✅ 应该看到：`成功获取用户问题:`
- ✅ 应该看到：`已存储到 sessionStorage`
- ✅ 应该看到：`检测到自动提问:`
- ✅ 应该看到：`开始执行 autoAskQuestion`

**测试 2: 直接输入（regex 匹配）**
```
输入: 今天天气怎么样
选择: 向AI提问
```
观察控制台输出：同上

**测试 3: 选中文本**
```
1. 在任何地方选中文本："今天天气怎么样"
2. 呼出 utools
3. 选择："使用AI进行web搜索"
```
观察控制台输出：同上

### 第三步：检查 sessionStorage
在控制台中输入：
```javascript
sessionStorage.getItem('autoAskQuestion')
```
- 如果返回问题内容，说明存储成功
- 如果返回 null，说明存储失败或已被清除

### 第四步：手动触发
如果自动触发失败，可以在控制台手动测试：
```javascript
sessionStorage.setItem('autoAskQuestion', '测试问题');
location.reload();
```

## 常见问题排查

### 问题 1: 没有任何控制台输出
**可能原因：**
- preload.js 没有正确加载
- utools 没有识别到功能

**解决方法：**
1. 检查 plugin.json 是否正确
2. 在 utools 中重新加载插件
3. 检查 preload.js 文件路径

### 问题 2: 有 "进入 AI 提问" 但没有后续输出
**可能原因：**
- action 对象结构不符合预期
- 无法获取用户输入

**解决方法：**
1. 查看控制台中打印的完整 action 对象
2. 找到实际包含用户输入的字段
3. 如果需要，请将 action 对象结构发送给开发者

### 问题 3: 有 "已存储到 sessionStorage" 但没有触发自动提问
**可能原因：**
- main.js 的 init 方法没有正确检查 sessionStorage
- sessionStorage 在页面加载前被清除

**解决方法：**
1. 检查 main.js 是否正确加载
2. 查看是否有 "检测到自动提问" 的日志
3. 检查是否有 API Key 配置

### 问题 4: 显示 "未配置 API Key"
**解决方法：**
1. 输入 `AI设置` 进入设置页面
2. 配置 API Key
3. 保存设置
4. 重新测试

## action 对象结构参考

根据不同的触发方式，action 对象可能有不同的结构：

### type: "over" 的可能结构
```javascript
{
  "type": "over",
  "payload": "选中的文本",
  // 或
  "text": "选中的文本"
}
```

### type: "regex" 的可能结构
```javascript
{
  "type": "regex",
  "payload": "用户输入的内容"
}
```

### 关键词触发的可能结构
```javascript
{
  "type": "text",
  "payload": "关键词后面的内容",
  "code": "ai_ask"
}
```

## 下一步改进建议

如果以上方法都不能解决问题，请：

1. **收集完整的 action 对象**
   - 将控制台中的 action 对象复制出来
   - 发送给开发者分析

2. **尝试简化配置**
   - 只保留一种触发方式进行测试
   - 确定哪种方式可以工作

3. **检查 utools 版本**
   - 确保 utools 是最新版本
   - 某些功能可能需要特定版本支持

## 临时解决方案

如果自动提问功能暂时无法使用，可以使用传统方式：
1. 输入 `AI` 或 `ai` 进入插件
2. 手动输入问题
3. 按回车发送

---

**最后更新：** 2025-10-29
**版本：** 1.0.1

